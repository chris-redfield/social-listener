{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>
        <p class="text-muted">Overview of your social media monitoring</p>
    </div>
    <div class="col-auto">
        <div class="d-flex align-items-center gap-3">
            <div class="d-flex align-items-center">
                <label class="me-2 text-muted">Timeline:</label>
                <select id="daysFilter" class="form-select form-select-sm" style="width: auto;">
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="60">Last 60 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
            <div class="d-flex align-items-center">
                <label class="me-2 text-muted">Listener:</label>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="listenerFilterBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                        All Listeners
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" id="listenerFilterMenu" style="min-width: 250px;">
                        <!-- Options loaded dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4" id="stats-cards">
    <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-emoji-smile me-2"></i>Sentiment Breakdown
            </div>
            <div class="card-body">
                <div id="sentiment-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-graph-up me-2"></i><span id="timeline-title">Posts Timeline (Last 30 Days)</span>
            </div>
            <div class="card-body">
                <div id="timeline-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Engagement Stats -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-hand-thumbs-up me-2"></i>Engagement Stats
            </div>
            <div class="card-body" id="engagement-stats">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store listeners data for reference
let allListeners = [];

document.addEventListener('DOMContentLoaded', async function() {
    // Load listeners for the filter dropdown
    await loadListenerFilter();
    // Load initial dashboard data
    loadDashboardData();

    // Handle days filter change
    document.getElementById('daysFilter').addEventListener('change', function() {
        loadDashboardData();
    });
});

async function loadListenerFilter() {
    const response = await fetch('/api/listeners');
    allListeners = await response.json();

    const menu = document.getElementById('listenerFilterMenu');
    menu.innerHTML = '';

    // Add "All Listeners" option
    const allItem = document.createElement('li');
    allItem.innerHTML = `
        <label class="dropdown-item">
            <input type="checkbox" class="form-check-input me-2" id="listener-all" checked>
            <span>All Listeners</span>
        </label>
    `;
    menu.appendChild(allItem);

    // Add divider
    const divider = document.createElement('li');
    divider.innerHTML = '<hr class="dropdown-divider">';
    menu.appendChild(divider);

    // Add individual listeners
    allListeners.forEach(listener => {
        const item = document.createElement('li');
        item.innerHTML = `
            <label class="dropdown-item">
                <input type="checkbox" class="form-check-input me-2 listener-checkbox" value="${listener.id}" data-name="${listener.name}">
                <span>${listener.name}</span>
            </label>
        `;
        menu.appendChild(item);
    });

    // Handle "All Listeners" checkbox
    document.getElementById('listener-all').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.listener-checkbox');
        if (this.checked) {
            checkboxes.forEach(cb => cb.checked = false);
        }
        updateFilterButton();
        loadDashboardData();
    });

    // Handle individual listener checkboxes
    document.querySelectorAll('.listener-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const allCheckbox = document.getElementById('listener-all');
            const anyChecked = document.querySelectorAll('.listener-checkbox:checked').length > 0;
            allCheckbox.checked = !anyChecked;
            updateFilterButton();
            loadDashboardData();
        });
    });
}

function updateFilterButton() {
    const btn = document.getElementById('listenerFilterBtn');
    const selected = getSelectedListenerNames();

    if (selected.length === 0) {
        btn.textContent = 'All Listeners';
    } else if (selected.length === 1) {
        btn.textContent = selected[0];
    } else {
        btn.textContent = `${selected.length} Listeners`;
    }
}

function getSelectedListenerIds() {
    const checkboxes = document.querySelectorAll('.listener-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    return ids.join(',');
}

function getSelectedListenerNames() {
    const checkboxes = document.querySelectorAll('.listener-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.dataset.name);
}

function getSelectedDays() {
    return document.getElementById('daysFilter').value;
}

async function loadDashboardData() {
    const listenerIds = getSelectedListenerIds();
    const days = getSelectedDays();
    const params = listenerIds ? `?listener_ids=${listenerIds}` : '';
    const timelineParams = params ? `${params}&days=${days}` : `?days=${days}`;

    // Update timeline title
    document.getElementById('timeline-title').textContent = `Posts Timeline (Last ${days} Days)`;

    // Load all data in parallel
    const [overviewResponse, sentimentResponse, timelineResponse, engagementResponse] = await Promise.all([
        fetch(`/api/analytics/overview${params}`),
        fetch(`/api/analytics/sentiment${params}`),
        fetch(`/api/analytics/timeline${timelineParams}`),
        fetch(`/api/analytics/engagement${params}`)
    ]);

    const [overviewData, sentimentData, timelineData, engagementData] = await Promise.all([
        overviewResponse.json(),
        sentimentResponse.json(),
        timelineResponse.json(),
        engagementResponse.json()
    ]);

    // Render all components
    renderStatsCards(overviewData);
    renderSentimentChart(sentimentData);
    renderTimelineChart(timelineData);
    renderEngagementStats(engagementData);
}

function renderStatsCards(data) {
    const container = document.getElementById('stats-cards');
    const selectedNames = getSelectedListenerNames();
    const listenerIds = getSelectedListenerIds();

    // Determine what to show in the "Active Listeners" card
    let listenersCardContent;
    if (!listenerIds || selectedNames.length === 0) {
        // No filter - show total count
        listenersCardContent = `
            <h6 class="card-title"><i class="bi bi-ear me-2"></i>Active Listeners</h6>
            <h2 class="mb-0">${data.total_listeners || 0}</h2>
        `;
    } else if (selectedNames.length === 1) {
        // Single listener selected - show name
        listenersCardContent = `
            <h6 class="card-title"><i class="bi bi-ear me-2"></i>Listener</h6>
            <h4 class="mb-0 text-truncate" title="${selectedNames[0]}">${selectedNames[0]}</h4>
        `;
    } else {
        // Multiple listeners selected - show count
        listenersCardContent = `
            <h6 class="card-title"><i class="bi bi-ear me-2"></i>Selected Listeners</h6>
            <h2 class="mb-0">${selectedNames.length}</h2>
        `;
    }

    container.innerHTML = `
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-chat-square-text me-2"></i>Total Posts</h6>
                    <h2 class="mb-0">${data.total_posts || 0}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    ${listenersCardContent}
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-tags me-2"></i>Entities Extracted</h6>
                    <h2 class="mb-0">${data.total_entities || 0}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <h6 class="card-title"><i class="bi bi-calendar-day me-2"></i>Posts Today</h6>
                    <h2 class="mb-0">${data.posts_today || 0}</h2>
                </div>
            </div>
        </div>
    `;
}

function renderEngagementStats(data) {
    const container = document.getElementById('engagement-stats');
    container.innerHTML = `
        <div class="row text-center">
            <div class="col-4">
                <h4 class="text-primary">${data.total_likes || 0}</h4>
                <small class="text-muted">Total Likes</small>
            </div>
            <div class="col-4">
                <h4 class="text-success">${data.total_replies || 0}</h4>
                <small class="text-muted">Total Replies</small>
            </div>
            <div class="col-4">
                <h4 class="text-info">${data.total_reposts || 0}</h4>
                <small class="text-muted">Total Reposts</small>
            </div>
        </div>
        <hr>
        <div class="row text-center">
            <div class="col-4">
                <h5>${data.avg_likes || 0}</h5>
                <small class="text-muted">Avg Likes</small>
            </div>
            <div class="col-4">
                <h5>${data.avg_replies || 0}</h5>
                <small class="text-muted">Avg Replies</small>
            </div>
            <div class="col-4">
                <h5>${data.avg_reposts || 0}</h5>
                <small class="text-muted">Avg Reposts</small>
            </div>
        </div>
    `;
}
</script>
{% endblock %}
